@using System.Linq
@using Feed_Bridge.Models.Entities
@model Cart
@{
    ViewData["Title"] = "سلة المنتجات";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success text-center fixed-top mt-3 w-50 mx-auto shadow">
        @TempData["Success"]
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger text-center fixed-top mt-3 w-50 mx-auto shadow">
        @TempData["Error"]
    </div>
}
<script>
    setTimeout(function () {
        let alerts = document.querySelectorAll('.alert');
        alerts.forEach(a => a.remove());
    }, 3000); // يختفي بعد 3 ثواني
</script>

<div class="container mt-5">
    <h2 class="cart-header text-center mb-4">🛒 سلة المنتجات</h2>


    <div class="cart-container">
        @if (Model == null || Model.ProductCarts == null || !Model.ProductCarts.Any())
        {
            <p class="text-center text-muted fs-5 mt-4">
                السلة فارغة حالياً
            </p>
            <div class="text-center mt-3">
                <a asp-controller="Product" asp-action="Index" class="btn btn-primary">
                    ⬅️ عودة للمنتجات
                </a>
            </div>
        }
        else
        {
            <div class="table-responsive shadow rounded-3">
                <table class="table table-striped table-hover align-middle text-center">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 17%;">الصورة</th>
                            <th style="width: 20%;">اسم المنتج</th>
                            <th style="width: 20%;">الكمية</th>
                            <th style="width: 28%;">تاريخ الانتهاء</th>
                            <th style="width: 5%;">تقليل الكميه</th>
                            <th style="width: 5%;">تزويد الكميه </th>
                            <th style="width: 5%;">حذف</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.ProductCarts)
                        {
                            <tr data-product-id="@item.ProductId">
                                <td>
                                    <img src="~/uploads/@(item.Product.ImgURL ?? "img.png")"
                                         alt="@item.Product.Name" width="80" height="80" />
                                </td>
                                <td>@item.Product.Name</td>
                                <td>
                                    <span class="mx-2 quantity">@item.Quantity</span>
                                </td>
                                <td>@item.Product.ExpirDate.ToString("yyyy/MM/dd")</td>
                                <td>
                                    <form asp-controller="Cart" asp-action="DecreaseQuantity" method="post">
                                        <input type="hidden" name="productId" value="@item.ProductId" />
                                        <button type="submit" class="btn btn-sm btn-outline-warning">➖</button>
                                    </form>
                                </td>
                                <td>
                                    <form asp-controller="Cart" asp-action="IncreaseQuantity" method="post">
                                        <input type="hidden" name="productId" value="@item.ProductId" />
                                        <button type="submit" class="btn btn-sm btn-outline-success">➕</button>
                                    </form>
                                </td>
                                <td>
                                    <button class="btn btn-danger remove-btn" data-product-id="@item.ProductId">إزالة</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="text-center mt-4">
                <form asp-controller="Order" asp-action="Confirm" method="post">
                    <button type="submit" class="btn btn-success btn-lg px-5">
                         تأكيد الطلب
                    </button>
                </form>
            </div>
        }
    </div>
</div>




@section Scripts {

    
    <script>
        function showAlert(message, type = "success") {
            let alertBox = `<div class="alert alert-${type} text-center">${message}</div>`;
            $(".cart-section").prepend(alertBox);
            setTimeout(() => $(".alert").fadeOut(), 2500);
        }

        // زيادة الكمية
        $(document).on("click", ".increase-btn", function () {
            let btn = $(this);
            let productId = btn.data("product-id");
            let row = btn.closest("tr");

            $.post("/Cart/IncreaseQuantity", { productId }, function (res) {
                if (res.success) {
                    let qtySpan = row.find(".quantity");
                    qtySpan.text(parseInt(qtySpan.text()) + 1);
                    showAlert(res.message, "success");
                } else {
                    showAlert(res.message, "danger");
                }
            });
        });

        // تقليل الكمية
        $(document).on("click", ".decrease-btn", function () {
            let btn = $(this);
            let productId = btn.data("product-id");
            let row = btn.closest("tr");

            $.post("/Cart/DecreaseQuantity", { productId }, function (res) {
                if (res.success) {
                    let qtySpan = row.find(".quantity");
                    let newQty = parseInt(qtySpan.text()) - 1;
                    if (newQty > 0) {
                        qtySpan.text(newQty);
                    } else {
                        row.remove();
                    }
                    showAlert(res.message, "success");
                } else {
                    showAlert(res.message, "danger");
                }
            });
        });

        // إزالة المنتج
        $(document).on("click", ".remove-btn", function () {
            let btn = $(this);
            let productId = btn.data("product-id");
            let row = btn.closest("tr");

            $.post("/Cart/Remove", { productId }, function (res) {
                if (res.success) {
                    row.remove();
                    showAlert(res.message, "success");
                } else {
                    showAlert(res.message, "danger");
                }
            });
        });
    </script>
}
